
question_content = """
ç»™ä½ ä¸€ä¸ªæ•°ç»„ nums ï¼Œå®ƒåŒ…å« n ä¸ªæ­£æ•´æ•°ã€‚ä½ éœ€è¦è®¡ç®—æ‰€æœ‰éç©ºè¿ç»­å­æ•°ç»„çš„å’Œï¼Œå¹¶å°†å®ƒä»¬æŒ‰å‡åºæ’åºï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„åŒ…å« n * (n + 1) / 2 ä¸ªæ•°å­—çš„
æ•°ç»„ã€‚ 

 è¯·ä½ è¿”å›åœ¨æ–°æ•°ç»„ä¸­ä¸‹æ ‡ä¸º left åˆ° right ï¼ˆä¸‹æ ‡ä» 1 å¼€å§‹ï¼‰çš„æ‰€æœ‰æ•°å­—å’Œï¼ˆåŒ…æ‹¬å·¦å³ç«¯ç‚¹ï¼‰ã€‚ç”±äºç­”æ¡ˆå¯èƒ½å¾ˆå¤§ï¼Œè¯·ä½ å°†å®ƒå¯¹ 10^9 + 7 å–æ¨¡åè¿”
å›ã€‚ 

# æµ‹è¯•ç”¨ä¾‹:[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100]
#         1000
#         1
#         500500

æµ‹è¯•ç”¨ä¾‹:[7,5,8,5,6,4,3,3]
        8
        2
        6
æµ‹è¯•ç»“æœ:20
æœŸæœ›ç»“æœ:23
 
è¾“å…¥ï¼šnums = [1,2,3,4], n = 4, left = 1, right = 10
è¾“å‡ºï¼š50
 
 ç¤ºä¾‹ 1ï¼š 

 
è¾“å…¥ï¼šnums = [1,2,3,4], n = 3, left = 1, right = 2
è¾“å‡ºï¼š3 
è§£é‡Šï¼šæ‰€æœ‰çš„å­æ•°ç»„å’Œä¸º 1, 3, 6, 10, 2, 5, 9, 3, 7, 4 ã€‚å°†å®ƒä»¬å‡åºæ’åºåï¼Œæˆ‘ä»¬å¾—åˆ°æ–°çš„æ•°ç»„ [1, 2, 3, 3, 4, 5, 
6, 7, 9, 10] ã€‚ä¸‹æ ‡ä» le = 1 åˆ° ri = 5 çš„å’Œä¸º 1 + 2 + 3 + 3 + 4 = 13 ã€‚
 

 ç¤ºä¾‹ 2ï¼š 

 
è¾“å…¥ï¼šnums = [1,2,3,4], n = 4, left = 3, right = 4
è¾“å‡ºï¼š6
è§£é‡Šï¼šç»™å®šæ•°ç»„ä¸ç¤ºä¾‹ 1 ä¸€æ ·ï¼Œæ‰€ä»¥æ–°æ•°ç»„ä¸º [1, 2, 3, 3, 4, 5, 6, 7, 9, 10] ã€‚ä¸‹æ ‡ä» le = 3 åˆ° ri = 4 çš„å’Œä¸º 
3 + 3 = 6 ã€‚
 

 ç¤ºä¾‹ 3ï¼š 

 
è¾“å…¥ï¼šnums = [1,2,3,4], n = 4, left = 1, right = 10
è¾“å‡ºï¼š50
 

 

 æç¤ºï¼š 

 
 1 <= nums.length <= 10^3 
 nums.length == n 
 1 <= nums[i] <= 100 
 1 <= left <= right <= n * (n + 1) / 2 
 

 Related Topics æ•°ç»„ åŒæŒ‡é’ˆ äºŒåˆ†æŸ¥æ‰¾ æ’åº ğŸ‘ 62 ğŸ‘ 0

"""

from typing import *
from PythonLeetcodeRunner import *

# @lc code=start
# leetcode submit region begin(Prohibit modification and deletion)
class Solution:
    def rangeSum(self, nums: List[int], n: int, left: int, right: int) -> int:
        """ å‰ç¼€å’Œçš„å‰ç¼€å’Œ + äºŒåˆ†æŸ¥æ‰¾ """
        mod = int(1e9 + 7)
        n = len(nums)

        # p: prefix sum
        p = [0]
        for i in range(n):
            p.append(p[-1] + nums[i])

        # pp: prefix sum of prefix sum
        pp = [0]
        for i in range(n + 1):
            pp.append((pp[-1] + p[i]) % mod)

        def countLargeThan(x):
            Sum = 0
            ret = 0
            # i: [0, n), j:[i, n)
            i, j = 0, -1
            while i < len(p) and j + 1 < len(p):
                # å¢å¤§kç›´è‡³ sum(arr[i:j+1]) >= k
                if p[j + 1] - p[i] < x:
                    j += 1
                else:
                    # æ­¤æ—¶ [j+1, len(p)) çš„å­åŒºé—´å’Œéƒ½å¤§äºç­‰äºk
                    ret += len(p) - (j + 1)
                    # p[j+1] - p[i] >= num, Sum = sum(p[j+1]-p[len(p)]) + sum(p[i])*ni
                    Sum += (pp[len(p)] - pp[j + 1]) - ((len(p) - j - 1) * p[i])
                    Sum %= mod
                    i += 1
            return ret, Sum

        def sumKLargest(k):
            """ å¯¹numsæœ€å¤§çš„kä¸ªå­æ•°ç»„å’Œè¿›è¡Œæ±‚å’Œ """
            if k <= 0:
                return 0
            LOWER, UPPER = 0, p[-1] + 1
            # æ‰¾åˆ°æœ€å¤§çš„x, s.t. å¤§äºç­‰äºxçš„å…ƒç´ æœ‰kä¸ª
            kLargest = bisect.bisect_left(range(LOWER, UPPER), True,
                                          key=lambda x: countLargeThan(x)[0] < k) - 1 + LOWER
            cnt, ans = countLargeThan(kLargest)

            # å¦‚æœå¤§äºç­‰äºkLargestçš„å…ƒç´ ä¸ªæ•°è¶…è¿‡äº†, å‡å»è¶…è¿‡çš„éƒ¨åˆ†
            ans -= kLargest * (cnt - k)

            return ans

        # æ’åºåå³è¾¹æœ‰kæ›´å¤§ä¸ªå…ƒç´ , å°±æ˜¯ç¬¬k+1å¤§
        ntotal = n * (n + 1) // 2
        # æŠŠç¬¬leftå°, è½¬åŒ–ä¸ºç¬¬ntotal-left+1å¤§, å†æŠŠntotal-rightå¤§çš„å’Œå‡å»
        return (sumKLargest(ntotal - left + 1) - sumKLargest(ntotal - right)) % mod

# leetcode submit region end(Prohibit modification and deletion)
# @lc code=end

if __name__ == "__main__":
    TestObj = StartTest(question_content, Solution)
    TestObj.run_test()
